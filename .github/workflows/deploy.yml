name: Deploy Wordle to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from Actions tab

permissions:
  contents: read
  pages: write
  id-token: write

# Only allow one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Create Supabase config from secrets
        run: |
          echo "Creating supabase-config.local.js with injected secrets..."
          cat > supabase-config.local.js << 'EOF'
          // Auto-generated by GitHub Actions
          // DO NOT commit this file
          const SUPABASE_CONFIG = {
            url: "${{ secrets.SUPABASE_URL }}",
            anonKey: "${{ secrets.SUPABASE_ANON_KEY }}"
          };
          EOF
          echo "âœ… Config file created"

      - name: ðŸ” Verify config (masked)
        run: |
          if [ -f supabase-config.local.js ]; then
            echo "âœ… supabase-config.local.js exists"
            echo "File size: $(wc -c < supabase-config.local.js) bytes"
            echo "First 50 chars of URL: $(grep 'url:' supabase-config.local.js | cut -c1-60)"
            echo "Key length: $(grep 'anonKey:' supabase-config.local.js | wc -c) chars"
            
            # Check if placeholders are still there
            if grep -q "YOUR_PROJECT" supabase-config.local.js; then
              echo "âŒ ERROR: Placeholder 'YOUR_PROJECT' still in file!"
              echo "Secrets may not be configured correctly"
              exit 1
            fi
            
            if grep -q "YOUR_ANON_KEY" supabase-config.local.js; then
              echo "âŒ ERROR: Placeholder 'YOUR_ANON_KEY' still in file!"
              echo "Secrets may not be configured correctly"
              exit 1
            fi
            
            echo "âœ… No placeholders found - secrets injected successfully"
          else
            echo "âŒ Config file not created!"
            exit 1
          fi

      - name: ðŸ“ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment complete
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "ðŸŒ Your site is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
